name: "Brand Impersonation: Mailgun"
description: "Impersonation of the Mailgun Email delivery platform."
type: "rule"
severity: "medium"
source: "type.inbound\nand (\n  any([\n        sender.display_name,\n        sender.email.domain.domain,\n        sender.email.local_part,\n        subject.subject\n      ],\n      strings.icontains(strings.replace_confusables(.), \"mailgun\")\n  )\n  or regex.icontains(body.html.raw, '<title>.*mailgun.*</title>')\n  or regex.icontains(body.current_thread.text,\n                     '[©®]\\s*(20\\d\\d\\s*)?Mailgun',\n                     'mailgun\\s*[©®]'\n  )\n  or any(ml.logo_detect(beta.message_screenshot()).brands, .name == \"Mailgun\" and .confidence in (\"medium\", \"high\") )\n)\nand not (\n  // sent from mailgun actual\n  (\n    sender.email.domain.root_domain in ('mailgun.com', 'mailgun.net')\n    and headers.auth_summary.dmarc.pass\n  )\n  or \n  // some domains have \"mailgun\" as a subdomain and are sent via mailgun\n  // these are unlikely to be impersonations\n  (\n    strings.icontains(sender.email.domain.domain, \"mailgun\")\n    and (\n      // if mailgun action was in the header.hops very likely not impersonation\n      // sample: https://platform.sublime.security/messages/ff12d4c08177c5505c29fc133201011c802029736f5ca28ee2acfffb60c02581\n      any(headers.domains, .root_domain in ('mailgun.com', 'mailgun.net'))\n      // but if not and there are 4 or more X-Mailgun headers, likely not impersonation\n      // sample: https://platform.sublime.security/messages/62c31e33ac6d8c5b5a8132ba577902eb7fb72775cd8182d168881033cb0751e1\n      or sum(map(filter(headers.hops, .index < 2),\n                 length(filter(.fields,\n                               strings.starts_with(.name, \"X-Mailgun-\")\n                        )\n                 )\n             )\n      ) > 4\n    )\n  )\n)\n// negate highly trusted sender domains unless they fail DMARC authentication\nand (\n  (\n    sender.email.domain.root_domain in $high_trust_sender_root_domains\n    and not headers.auth_summary.dmarc.pass\n  )\n  or sender.email.domain.root_domain not in $high_trust_sender_root_domains\n)\n"
attack_types:
  - "Credential Phishing"
  - "BEC/Fraud"
tactics_and_techniques:
  - "Impersonation: Brand"
detection_methods:
  - "Sender analysis"
id: "59cc84e6-e16c-58e7-94ad-78dad315e5ab"
testing_pr: 1849
testing_sha: 33aff19129c07ef654244af81207d7b183bb3f64
