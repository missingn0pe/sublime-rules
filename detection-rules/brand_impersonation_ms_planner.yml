name: "Brand impersonation: Microsoft Planner with suspicious link"
description: "Impersonation of Microsoft Planner, a component of the Microsoft 365 software suite."
type: "rule"
severity: "medium"
source: "type.inbound\n// suspicious link \nand any(body.links,\n        (\n          .href_url.domain.root_domain not in $tranco_1m\n          or .href_url.domain.domain in $free_file_hosts\n          or .href_url.domain.root_domain in $free_file_hosts\n          or .href_url.domain.root_domain in $free_subdomain_hosts\n          or .href_url.domain.domain in $url_shorteners\n          or \n\n          // mass mailer link, masks the actual URL\n          .href_url.domain.root_domain in (\n            \"hubspotlinks.com\",\n            \"mandrillapp.com\",\n            \"sendgrid.net\",\n            \"rs6.net\"\n          )\n\n          // Google AMP redirect\n          or (\n            .href_url.domain.sld == \"google\"\n            and strings.starts_with(.href_url.path, \"/amp/\")\n          )\n\n          // Recipient email address in link\n          or any(body.links,\n                 any(recipients.to,\n                     strings.icontains(..href_url.url, .email.email)\n                     and any(recipients.to, .email.domain.valid)\n                 )\n          )\n          or .href_url.domain.root_domain == \"beehiiv.com\"\n        )\n\n        // exclude sources of potential FPs\n        and (\n          .href_url.domain.root_domain not in (\n            \"svc.ms\",\n            \"sharepoint.com\",\n            \"1drv.ms\",\n            \"microsoft.com\",\n            \"aka.ms\",\n            \"msftauthimages.net\",\n            \"mimecastprotect.com\",\n            \"office.com\",\n            \"microsoftproject.com\"\n          )\n          or any(body.links, .href_url.domain.domain in $free_file_hosts)\n        )\n        and .href_url.domain.root_domain not in $org_domains\n        and .href_url.domain.valid\n        and regex.icontains(.display_text,\n                            \"(go.?to|view|show|display|access) (team|planner|group|task)\"\n        )\n)\n\n// not a reply\nand (\n  length(headers.references) == 0\n  or not any(headers.hops, any(.fields, strings.ilike(.name, \"In-Reply-To\")))\n)\n\n// Planner logo\n// LogoDetect coming soon\nand (\n  all(attachments,\n      .file_type in $file_types_images\n      and any(file.explode(.),\n              // small, relatively square image\n              (\n                .scan.exiftool.image_height / .scan.exiftool.image_width\n              ) > 0.9\n              and (.scan.exiftool.image_height + .scan.exiftool.image_width) < 500\n      )\n  )\n)\n\n// suspicious content\nand (\n  2 of (\n    strings.ilike(body.current_thread.text, \"*assigned*new team*\"),\n    strings.ilike(body.current_thread.text, \"*Microsoft Office 365*\"),\n    strings.ilike(body.current_thread.text, \"*internal planner*\")\n  )\n  or (\n    any(ml.nlu_classifier(body.current_thread.text).intents,\n        .name == \"cred_theft\" and .confidence in~ (\"medium\", \"high\")\n    )\n  )\n)\nand sender.email.domain.root_domain not in (\n  \"bing.com\",\n  \"microsoft.com\",\n  \"microsoftonline.com\",\n  \"microsoftproject.com\",\n  \"microsoftstoreemail.com\",\n  \"microsoftsupport.com\",\n  \"microsoft365.com\",\n  \"office.com\",\n  \"office365.com\",\n  \"onedrive.com\",\n  \"sharepointonline.com\",\n  \"yammer.com\",\n)\n\n// negate highly trusted sender domains unless they fail DMARC authentication\nand (\n  (\n    sender.email.domain.root_domain in $high_trust_sender_root_domains\n    and not headers.auth_summary.dmarc.pass\n  )\n  or sender.email.domain.root_domain not in $high_trust_sender_root_domains\n)\nand (\n  not profile.by_sender().solicited\n  or (\n    profile.by_sender().any_messages_malicious_or_spam\n    and not profile.by_sender().any_false_positives\n  )\n)\nand not profile.by_sender().any_false_positives\n\n// exclude marketing jargon from ms partners\nand not regex.icontains(body.current_thread.text,\n                        '(schedul(e|ing)|set up).{0,20}(call|meeting|demo|zoom|conversation|time|tool|discussion)|book.{0,10}(meeting|demo|call|slot|time)|connect.{0,12}(with me|phone|email)|my.{0,10}(calendar|cal)|reserve.{0,10}s[pl]ot|break the ice|want to know more?|miss your chance|if you no longer wish|if you no longer want|if you wish to opt out|low-code (development|approach|solution|journey|platform)|invite.{0,30}(webinar|presentation)'\n)\n"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Image as content"
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Natural Language Understanding"
  - "Sender analysis"
  - "URL analysis"
id: "ea363c08-479f-5437-9b5d-3d9e07098200"
testing_pr: 1822
testing_sha: 6d2e81707aab42ae728dc6066fb15c32dbdd1f36
